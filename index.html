<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bingo Login & Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fafafa;
    }
    @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
    }
    .container {
      display: flex;
      gap: 40px;
      align-items: flex-start;
      max-width: 100%;
      flex-wrap: wrap;
    }

    .sidebar, .leaderboard {
      width: 160px;
      flex-shrink: 0;
    }

    .team-header {
      font-weight: bold;
      text-decoration: underline;
      margin-bottom: 6px;
    }

    .team-member {
      margin-left: 10px;
      margin-bottom: 4px;
      user-select: none;
    }

    .board {
      display: grid;
      gap: 10px;
      border: 2px solid #555;
      border-radius: 12px;
      padding: 10px;
      background: white;
      user-select: none;
      justify-content: center;
    }

    .cell {
      width: 100px;
      height: 100px;
      background: #f0f0f0;
      border: 2px solid #555;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2em;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
      text-align: center;
      padding: 6px;
    }

    .cell:hover {
      background-color: #ddd;
    }

    .cell .media-indicator {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 16px;
      height: 16px;
      background: url('data:image/svg+xml;utf8,<svg fill="black" height="16" width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/></svg>') no-repeat center center;
      background-size: contain;
      opacity: 0.7;
    }

    form > input, form > button {
      font-size: 1em;
      padding: 6px;
      margin-top: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    .error-message {
      color: red;
      margin-bottom: 12px;
      user-select: none;
    }

    .modal-overlay {
      position: fixed;
      aspect-ratio: 1/1;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease forwards;
      z-index: 999;
    }

    .modal-content {
      background: white;
      aspect-ratio: 1/1;
      /* padding: 24px; */
      border-radius: 8px;
      max-width: 80%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: fadeInScale 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    @keyframes fadeInScale {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      body, html {
        align-items: flex-start;
        padding-top: 20px;
      }

      .container {
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 100%;
        padding: 0 10px;
      }

      .board {
        max-width: 95%;
      }

      .sidebar, .leaderboard {
        width: 95%;
        text-align: center;
        font-size: 2rem;
      }

      .team-member {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const e = React.createElement;
    const socket = io("https://tunnel.bingogame.gay", {
      withCredentials: true,
      transports: ['websocket'],
    });

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days = 1) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; path=/; expires=${expires}`;
    }

    function App() {
      const [user, setUser] = React.useState(getCookie("username"));
      const [username, setUsername] = React.useState("");
      const [password, setPassword] = React.useState("");
      const [error, setError] = React.useState("");
      const [gameState, setGameState] = React.useState(null);
      const [teamNumber, setTeamNumber] = React.useState(null);
      const [modalVisible, setModalVisible] = React.useState(false);
      const [modalContent, setModalContent] = React.useState(null);

      React.useEffect(() => {
        if (user) {
          fetch("https://tunnel.bingogame.gay/game_state", {
            credentials: "include"
          })
            .then(res => res.json())
            .then(data => {
              setGameState(data);
              for (const [teamNum, team] of Object.entries(data.teams || {})) {
                if (team.members.includes(user)) {
                  setTeamNumber(Number(teamNum));
                  break;
                }
              }
            })
            .catch(() => setError("Failed to load game data"));
        }
      }, [user]);

      const handleLogin = async (e) => {
        e.preventDefault();
        setError("");
        try {
          const response = await fetch("https://tunnel.bingogame.gay/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username, password }),
          });
          const data = await response.json();
          if (response.ok && data.success) {
            setCookie("username", username);
            setUser(username);
          } else {
            setError(data.error || "Login failed");
          }
        } catch (err) {
          setError("Network error");
        }
      };

      const handleClick = (row, col) => {
        if (!gameState) return;
        const index = row * gameState.grid_size + col;
        const cell = gameState.board[index];
        setModalContent(cell.description || "No description available.");
        setModalVisible(true);
      };

      if (!user) {
        return e("div", { style: { maxWidth: 320 } }, [
          e("h2", null, "Login to Play Bingo"),
          error && e("div", { className: "error-message" }, error),
          e("form", { onSubmit: handleLogin }, [
            e("input", {
              type: "text",
              placeholder: "Username",
              value: username,
              onChange: (e) => setUsername(e.target.value),
              required: true
            }),
            e("input", {
              type: "password",
              placeholder: "Password",
              value: password,
              onChange: (e) => setPassword(e.target.value),
              required: true
            }),
            e("button", { type: "submit" }, "Login")
          ])
        ]);
      }

      if (!gameState) {
        return e("div", null, "Loading game...");
      }

      const teamInfo = gameState.teams?.[teamNumber] || { members: [], color: "black" };

      const board = [];
      for (let i = 0; i < gameState.board.length; i++) {
        const square = gameState.board[i];
        const row = Math.floor(i / gameState.grid_size);
        const col = i % gameState.grid_size;
        const claimed = square.claimed_by;
        const lastTeam = claimed.length ? claimed[claimed.length - 1] : null;
        const teamColor = lastTeam ? (gameState.teams[lastTeam]?.color || "transparent") : "transparent";
        const bg = teamColor.startsWith("#") ? hexToRGBA(teamColor, 0.2) : teamColor;
        board.push(
          e("div", {
            key: i,
            className: "cell",
            style: { backgroundColor: bg },
            onClick: () => handleClick(row, col)
          }, [
            square.title || `Square ${i + 1}`,
            square.media?.length ? e("div", { className: "media-indicator", key: "media" }) : null
          ])
        );
      }

      const leaderboard = Object.entries(gameState.teams || {})
        .map(([num, team]) => ({ team: num, score: team.score, color: team.color }))
        .sort((a, b) => b.score - a.score);

      return e("div", { style: { display: "flex", flexDirection: "column", alignItems: "center", width: "100%" } }, [

        // Welcome
        e("div", {
          style: {
            marginBottom: "16px",
            fontSize: "1.4em",
            fontWeight: "bold",
            textAlign: "center"
          }
        }, [
          "Welcome, ",
          e("span", { style: { color: teamInfo.color } }, user)
        ]),

        // Layout
        e("div", { className: "container" }, [
          e("div", { className: "sidebar" }, [
            e("div", { className: "team-header", style: { color: teamInfo.color } }, `Team ${teamNumber}`),
            ...teamInfo.members.map(name =>
              e("div", { className: "team-member", style: { color: teamInfo.color }, key: name }, name)
            )
          ]),
          e("div", {
            className: "board",
            style: { gridTemplateColumns: `repeat(${gameState.grid_size}, 1fr)` }
          }, board),
          e("div", { className: "leaderboard" }, [
            e("div", { className: "team-header" }, "Leaderboard"),
            ...leaderboard.map(entry =>
              e("div", { style: { color: entry.color }, key: entry.team }, `Team ${entry.team}: ${entry.score}`)
            )
          ])
        ]),

        // Modal
        modalVisible && modalContent && e("div", {
    className: "modal-overlay",
    style: {
        position: "fixed",
        top: 0,
        left: 0,
        width: "100vw",
        height: "100vh",
        backgroundColor: "rgba(0, 0, 0, 0.6)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        animation: "fadeIn 0.3s ease"
    },
    onClick: () => setModalVisible(false)
    }, e("div", {
        className: "modal-content",
        style: {
            backgroundColor: "white",
            padding: "30px",
            borderRadius: "12px",
            width: "80%",
            height: "80%",
            overflowY: "auto",
            boxShadow: "0 4px 12px rgba(0, 0, 0, 0.3)",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "flex-start",
            textAlign: "center"
            },
        onClick: e => e.stopPropagation()
    }, [
        e("h2", null, modalContent.title || "Untitled"),
        e("p", null, modalContent.description || "No description available."),
        modalContent.points?.length > 0 && e("p", null, `Points: ${modalContent.points[0]}`),
        e("p", { style: { marginTop: "10px", fontWeight: "bold" } }, "Teams Completed:"),
        e("p", null, (modalContent.completed_teams?.length > 0 ? modalContent.completed_teams.join(", ") : "None")),

        e("button", {
            style: { marginTop: "12px" }
        }, "Claim Spot"),

        // Only show these if the logged in team has completed it
        (modalContent.completed_teams?.includes(teamNumber)) && e(React.Fragment, null, [
            e("button", { style: { marginTop: "12px" } }, "Add Media"),
            e("input", {
                type: "text",
                placeholder: "Quantity (if applicable)",
                style: { display: "block", marginTop: "10px", width: "100%" }
            }),
            e("textarea", {
                placeholder: "Comment",
                rows: 3,
                style: { display: "block", marginTop: "10px", width: "100%" }
            }),
            e("button", {
                style: { marginTop: "12px" }
            }, "Save")
        ])
    ]))

      ]);
    }

    function hexToRGBA(hex, alpha = 0.2) {
      let r = 0, g = 0, b = 0;
      if (hex.length === 7) {
        r = parseInt(hex.slice(1, 3), 16);
        g = parseInt(hex.slice(3, 5), 16);
        b = parseInt(hex.slice(5, 7), 16);
      } else if (hex.length === 4) {
        r = parseInt(hex[1] + hex[1], 16);
        g = parseInt(hex[2] + hex[2], 16);
        b = parseInt(hex[3] + hex[3], 16);
      }
      return `rgba(${r},${g},${b},${alpha})`;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(e(App));
  </script>
</body>
</html>
